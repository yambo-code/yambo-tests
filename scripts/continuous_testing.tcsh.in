#!/usr/bin/tcsh
#
while ( 1 > 0) 
 #
 # update branch and flows
 #
 cd @test_suite_dir@
 git pull
 ./scripts/wget_from_google_drive.sh
 set files=`find ROBOTS/@robot@/@user@/FLOWS -name 'run*tcsh' | xargs rm -f`
 rm -f ROBOTS/@robot@/@user@/FLOWS/run.*
 cat control_room.csv | awk -f scripts/robot_update.awk
 #
 # Files to run
 #
 set files=`find ROBOTS/@robot@/@user@/FLOWS -name 'run*tcsh'`
 set log_dir="."
 #
 # Check if robot is free
 #
 set NR=`find ~/yambo-testing/ -name '*is_running' |wc -l`
 #
 if ( $NR < 3 && ! -f ~/yambo-testing/@robot@ && "$files" != "" ) then
  #
  foreach run_file ( ROBOTS/@robot@/@user@/FLOWS/run.*.tcsh )
   #
   source $run_file
   set flow=`basename $run_file`
   set flow=`echo $flow |sed 's/.tcsh//'`
   #
   set branch_dir=~/yambo-testing/$ybranch
   mkdir -p $branch_dir
   #
   cd @source_dir@
   git pull
   git checkout $ybranch
   git pull
   set last_hash=`git log --pretty=format:"%h" | head -n 1` 
   cd @test_suite_dir@
   #
   set off_flag=" "
   if ( "$options" == "mpioff" ) then
     set off_flag="-o mpi"
   endif
   #
   # stop if needed
   if ( -f ~/yambo-testing/stop_@robot@ ) break
   #
   if ( ! -f "$branch_dir/last_tested_hash.$last_hash" ) then
    set M=`date +%m`
    set D=`date +%d`
    set T=`date +%T`
    set log_dir="$branch_dir/$M/$D"
    echo "================================================================================================================="
    date
    echo "launcher.tcsh -y $ybranch -t $tbranch -m $module -f $flow $off_flag -r > $log_dir/log-@robot@-${flow}-${T}"
    mkdir -p $log_dir
    rm -f $branch_dir/latest_logs
    ln -s $log_dir $branch_dir/latest_logs
    @test_suite_dir@/scripts/reset.sh
    touch ~/yambo-testing/@robot@_is_running
    @test_suite_dir@/scripts/launcher.tcsh -y $ybranch -t $tbranch -m $module -f $flow $off_flag -r > $log_dir/log-@robot@-${flow}-${T} 
    @test_suite_dir@/driver.pl -kill > /dev/null
    echo "done"
    echo "================================================================================================================="
   endif
   #
  end
  #
  if ( "$ybranch" != "" && -f  ~/yambo-testing/@robot@_is_running ) then
   rm -f $branch_dir/last_tested_hash.*
   touch $branch_dir/last_tested_hash.$last_hash
   rm -f ~/yambo-testing/@robot@_is_running
  endif
  #
 endif
 #
 sleep 10m
 #
end
