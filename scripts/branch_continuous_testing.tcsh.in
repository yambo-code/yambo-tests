#!/usr/bin/tcsh
#
while ( 1 > 0) 
 #
 # update branch and flows
 #
 cd @test_suite_dir@
 ./scripts/wget_from_google_drive.sh
 set files=`find ROBOTS/@robot@/@user@/FLOWS -name 'run*tcsh' | xargs rm -f`
 rm -f ROBOTS/@robot@/@user@/FLOWS/run.*
 cat control_room.csv | awk -f scripts/robot_update.awk
 #
 set files=`find ROBOTS/@robot@/@user@/FLOWS -name 'run*tcsh'`
 #
 if ( "$files" != "" ) then
  #
  foreach run_file ( ROBOTS/@robot@/@user@/FLOWS/run.*.tcsh )
   #
   source $run_file
   set flow=`basename $run_file`
   set flow=`echo $flow |sed 's/.tcsh//'`
   #
   set branch_dir=~/yambo-testing/$branch
   mkdir -p $branch_dir
   #
   cd @source_dir@
   git checkout $branch
   set last_hash=`git log --pretty=format:"%h" | head -n 1` 
   cd @test_suite_dir@
   #
   # stop if needed
   if ( -f ~/stop_the_@robot@ ) break
   #
   # count the running robots
   set NR=`find ~/yambo-testing/ -name '*is_running' |wc -l`
   if ( $NR > 3 ) continue
   #
   if ( ! -f "$branch_dir/last_tested_hash.$last_hash" ) then
    touch ~/yambo-testing/@robot@_is_running
    @test_suite_dir@/scripts/reset.sh 
    @test_suite_dir@/scripts/test-suite-launcher.tcsh -y $branch -t devel-andreaM -m $module -f $flow  > $branch_dir/log-@robot@-${flow}-${TIME} 
    @test_suite_dir@/driver.pl -kill > /dev/null
   endif
   #
  end
  #
  if ( "$branch" != "" ) then
   rm -f $branch_dir/last_tested_hash.*
   touch $branch_dir/last_tested_hash.$last_hash
   rm -f ~/yambo-testing/@robot@_is_running
  endif
  #
 endif
 #
 sleep 10m
 #
end
